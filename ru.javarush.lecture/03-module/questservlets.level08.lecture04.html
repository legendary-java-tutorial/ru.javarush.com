NAT
<p>----------------------------------------</p>
Знакомство в NAT
Терминология NAT
Путь прохождения пакета
Преимущества и недостатки NAT
<p>----------------------------------------</p>
<h2>5.1 Знакомство в NAT</h2>
<p>Еще одна очень интересная тема – это NAT. NAT расшифровывается как <strong>Network Address Translation</strong> и обычно присутствует в каждом роутере как некий сервис. Так что же это такое и зачем оно нужно?</p>
<p><strong>NAT</strong> – это точка, с помощью которой локальные сети можно подключать к глобальным сетям, таким как интернет, например.</p>
<p>Как ты уже знаешь, в локальных сетях у всех компьютеров (и других устройств, подключенных к сети) есть свои собственные локальные IP-адреса. А чтобы обмениваться данными с сервером в интернете, надо чтобы наш компьютер мог послать запрос к серверу и сервер мог прислать нам ответ. А куда ему присылать ответ, если наш IP-адрес неизвестен за рамками нашей локальной сети?</p>
<p>Представь, что ты пишешь бумажное письмо Дональду Трампу. Трамп – это публичная фигура, он такой один – это наш публичный сервер. А в качестве обратного адреса в письме вы указываете Машу. Маш много. Какой именно Маше нужно прислать ответ?</p>
<p>Поэтому ты отправляешь письмо своему знакомому из Вашингтона, тоже публичной фигуре, со строгим указанием выслать его Трампу. Твой знакомый получает письмо, шлет его Трампу, а в качестве обратного адреса указывает свой адрес в Вашингтоне.</p>
<p>Затем, получив ответ от Трампа, знакомый пересылает его тебе. Так же и с IP-пакетами…</p>
<p>Чтобы позволить устройству с приватным IPv4-адресом обращаться к устройствам и ресурсам за пределами локальной сети, приватный адрес сначала должен быть изменен на общедоступный публичный адрес.</p>
<p>Как раз NAT переводит приватные адреса в общедоступные. Это позволяет устройству с локальным IP-адресом обращаться к ресурсам за пределами его частной сети. NAT в сочетании с локальными IP-адресами оказался полезным методом сохранения общедоступных IPv4-адресов.</p>
<p>В мире живет 8 миллиардов человек, а сетевых устройств уже в разы больше: телефоны, ноутбуки, смарт-часы, сервера, любые умные устройства. А IP-адресов всего 4 миллиарда. Раньше казалось, что это много, но с быстрым ростом интернета всем стало понятно, что этого недостаточно.</p>
<p>Тут нам на помощь приходит NAT: один публичный IPv4-адрес может быть использован сотнями, даже тысячами устройств, каждый из которых имеет локальный IPv4-адрес. NAT имеет дополнительное преимущество, заключающееся в добавлении степени конфиденциальности и безопасности в сеть, поскольку он скрывает внутренние IPv4-адреса из внешних сетей.</p>
<h2>5.2 Подсети в NAT</h2>
<p>Локальные сети обычно проектируются с использованием частных IP-адресов. Это адреса из приватных подсетей <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code> и <code>192.168.0.0/16</code>. Эти IP-адреса используются внутри организации или площадки, чтобы позволить устройствам общаться локально, они не маршрутизируются в интернете.</p>
<p>Роутеры с поддержкой NAT могут быть настроены с одним или несколькими действительными общедоступными IPv4-адресами. Эти общедоступные адреса называются пулом NAT.</p>
<p>Когда устройство из внутренней сети отправляет трафик из сети наружу, то роутер с поддержкой NAT переводит внутренний IP-адрес устройства на публичный IP-адрес из пула NAT. Для внешних устройств весь трафик, входящий и выходящий из сети, выглядит имеющим общедоступный IP-адрес.</p>
<p>Маршрутизатор NAT обычно работает на границе Stub-сети. Stub-сеть – это термин из теории сетей: тупиковая сеть, которая имеет одно соединение с соседней сетью, один вход и выход из сети.</p>
<img data-max-width="1024" data-id="1b701199-4628-43ca-bef0-8cc2bc1474b8" src="https://cdn.javarush.com/images/article/1b701199-4628-43ca-bef0-8cc2bc1474b8/1024.jpeg" alt="">
<p>Когда устройство внутри Stub-сети хочет связываться с устройством за пределами своей сети, пакет пересылается роутеру и он выполняет NAT-процесс, переводя внутренний частный адрес устройства на публичный, внешний, маршрутизируемый адрес.</p>
<h2>5.3 Терминология NAT</h2>
<p>Если углубиться в теорию сетей, то NAT — это внутренняя сеть, которая представляет собой набор подсетей, подлежащих переводу. Внешняя сеть относится ко всем другим сетям.</p>
<p>При использовании NAT, IP адреса имеют разные обозначения, основанные на том, находятся ли они в частной сети или в общедоступной сети (в интернете) и является ли трафик входящим или исходящим.</p>
<p>NAT включает в себя четыре типа адресов:</p>
<ul>
    <li><strong>Внутренний локальный адрес</strong> (Inside local address);</li>
    <li><strong>Внутренний глобальный адрес</strong> (Inside global address);</li>
    <li><strong>Внешний местный адрес</strong> (Outside local address);</li>
    <li><strong>Внешний глобальный адрес</strong>  (Outside global address);</li>
</ul>
<p>При определении того, какой тип адреса используется, важно помнить, что терминология NAT всегда применяется с точки зрения устройства с транслированным адресом:</p>
<ul>
    <li><strong>Внутренний адрес</strong> (Inside address) – адрес устройства, которое транслируется NAT;</li>
    <li><strong>Внешний адрес</strong> (Outside address) – адрес устройства назначения;</li>
    <li><strong>Локальный адрес</strong> (Local address) – это любой адрес, который отображается во внутренней части сети;</li>
    <li><strong>Глобальный адрес</strong> (Global address) – это любой адрес, который отображается во внешней части сети.</li>
</ul>
<p>Рассмотрим это на примере схемы.</p>
<img data-max-width="1024" data-id="dfbcd791-f023-4b1e-9ece-1637d4a5b715" src="https://cdn.javarush.com/images/article/dfbcd791-f023-4b1e-9ece-1637d4a5b715/1024.jpeg" alt="">
<p>Компьютер на рисунке слева имеет внутренний локальный (<strong>Inside local</strong>) адрес <code>192.168.1.5</code> и с его точки зрения веб-сервер имеет внешний (<strong>outside</strong>) адрес <code>208.141.17.4</code>. Когда с компьютера отправляются пакеты данных на глобальный адрес веб-сервера, внутренний локальный (<strong>Inside local</strong>) адрес ПК транслируется в <code>208.141.16.5</code> (<strong>inside global</strong>). Адрес внешнего устройства обычно не переводится, поскольку он является общедоступным адресом IPv4.</p>
<p>Стоит заметить, что компьютер имеет как бы два адреса: локальный и глобальный адреса, тогда как веб-сервер имеет одинаковый публичный IP-адрес. С его точки зрения трафик, исходящий из компьютера, поступает из внутреннего глобального адреса <code>208.141.16.5</code>. Роутер с NAT является точкой разделения между внутренней и внешней сетями, и между локальными и глобальными адресами.</p>
<p>Термины <strong>inside</strong> и <strong>outside</strong> объединены с терминами <strong>local</strong> и <strong>global</strong>, чтобы ссылаться на конкретные адреса. На рисунке роутер настроен на предоставление NAT и имеет пул общедоступных адресов для назначения внутренним хостам.</p>
<h2>5.4 Путь прохождения пакета</h2>
<p>Если ты уже устал, то переходи к следующей лекции. Если тебе все еще интересно, то добро пожаловать дальше в кротовую нору.</p>
<p>На рисунке ниже показано, как трафик отправляется с внутреннего компьютера на внешний веб-сервер через маршрутизатор с поддержкой NAT, высылается и переводится в обратную сторону.</p>
<img data-max-width="1024" data-id="64fead98-c4dd-4309-ae80-88fb61cee243" src="https://cdn.javarush.com/images/article/64fead98-c4dd-4309-ae80-88fb61cee243/1024.jpeg" alt="Подсети в NAT 3">
<table>
    <tbody align="center">
    <tr>
        <th colspan="4" 
        >NAT-таблица маршрутизатора</th>
    </tr>
    <tr>
        <td colspan="2">ПК</td>
        <td colspan="2">Веб-сервер</td>
    </tr>
        <tr>
        <td>Insde Global</td>
        <td>Inside Local</td>
        <td>Outside Local</td>
        <td>Outside Global</td>
       </tr> 
        <tr>
        <td>208.141.17.4</td>
        <td>192.168.1.5</td>
        <td>208.141.16.5</td>
        <td>208.141.16.5</td>
    </tr>
    </tbody>
</table>
<p>Внутренний локальный адрес (<strong>Inside local address</strong>) – адрес источника, видимый из внутренней сети. На рисунке адрес <code>192.168.1.5</code> присвоен компьютеру – это и есть его внутренний локальный адрес.</p>
<p>Внутренний глобальный адрес (Inside global address) – адрес источника, видимый из внешней сети. На рисунке, когда трафик с компа отправляется на веб-сервер по адресу <code>208.141.17.4</code>, роутер переводит внутренний локальный адрес (local address) на внутренний глобальный адрес (Inside global address). В этом случае роутер изменяет адрес источника <strong>IPv4</strong> с <code>192.168.1.5</code> на <code>208.141.16.5</code>.</p>
<p>Внешний глобальный адрес (Outside global address) – адрес адресата, видимый из внешней сети. Это глобально маршрутизируемый IP-адрес, назначенный хосту в интернете. На схеме веб-сервер доступен по адресу <code>208.141.17.4</code>. Чаще всего внешние локальные и внешние глобальные адреса одинаковы.</p>
<p>Внешний локальный адрес (Outside local address) – адрес получателя, видимый из внутренней сети. В этом примере комп отправляет трафик на веб-сервер по адресу <code>208.141.17.4</code></p>
<p>Теперь давай рассмотрим весь путь прохождения пакета. Комп с адресом <code>192.168.1.5</code> пытается установить связь с веб-сервером <code>208.141.17.4</code>. Когда пакет прибывает в маршрутизатор с поддержкой NAT, он считывает IP-адрес назначения пакета, чтобы определить, соответствует ли пакет критериям, указанным для перевода. В этом примере исходный адрес соответствует критериям и переводится с <code>192.168.1.5</code> (Inside local address) на <code>208.141.16.5</code> (Inside global address).</p>
<p>Роутер добавляет это сопоставление локального в глобальный адрес в таблицу NAT и отправляет пакет с переведенным адресом источника в пункт назначения. Веб-сервер отвечает пакетом, адресованным внутреннему глобальному адресу ПК (<code>208.141.16.5</code>).</p>
<p>Роутер получает пакет с адресом назначения <code>208.141.16.5</code> и проверяет таблицу NAT, в которой находит запись для этого сопоставления. Он использует эту информацию и переводит обратно внутренний глобальный адрес (<code>208.141.16.5</code>) на внутренний локальный адрес (<code>192.168.1.5</code>), пакет перенаправляется в сторону ПК.</p>
<h2>5.5 Преимущества и недостатки NAT</h2>
<p>Сервис NAT – это очень мощное решение, которое используется повсеместно. NAT предоставляет <strong>множество преимуществ</strong>, в том числе:</p>
<ul>
    <li>NAT сохраняет зарегистрированную схему адресации, обеспечивая гибкую работу локальных сетей. При NAT внутренние хосты могут совместно использовать один публичный IP-адрес для всех внешних коммуникаций. В этом типе конфигурации требуется очень мало внешних адресов для поддержки многих внутренних хостов.</li>
    <li>NAT повышает гибкость соединений с интернетом. Многочисленные пулы, пулы резервного копирования и пулы балансировки нагрузки могут быть реализованы для обеспечения надежных общедоступных сетевых подключений.</li>
    <li>NAT обеспечивает согласованность для внутренних схем адресации сети. В сети, не использующей частные IP-адреса и NAT, изменение общей схемы IP-адресов требует переадресации всех хостов в существующей сети. Стоимость переадресации хостов может быть значительной. NAT позволяет существующей частной адресной схеме IPv4 оставаться, позволяя легко изменять новую схему общедоступной адресации. Это означает, что организация может менять провайдеров и не нужно менять ни одного из своих внутренних клиентов.</li>
    <li>NAT <strong>обеспечивает сетевую безопасность</strong>. Поскольку частные сети не рекламируют свои адреса или внутреннюю топологию, они остаются достаточно надежными при использовании в сочетании с NAT для получения контролируемого внешнего доступа. Однако нужно понимать, что NAT не заменяет фаерволы</li>
</ul>
<p>Но у NAT есть некоторые <strong>недостатки</strong>. Тот факт, что хосты в интернете, по-видимому, напрямую взаимодействуют с устройством с поддержкой NAT, а не с  фактическим хостом внутри частной сети, создает ряд проблем:</p>
<ul>
    <li>Один из недостатков использования NAT связан с производительностью сети, особенно для протоколов реального времени, таких как VoIP. NAT увеличивает задержки переключения, потому что перевод каждого IP-адреса в заголовках пакетов требует времени.</li>
    <li> Другим недостатком использования NAT является то, что сквозная адресация теряется. Многие интернет-протоколы и приложения зависят от сквозной адресации от источника до места назначения. Некоторые приложения не работают с NAT. Приложения, которые используют физические адреса, а не квалифицированное доменное имя, не доходят до адресатов, которые транслируются через NAT-маршрутизатор. Иногда этого можно избежать, реализуя статические сопоставления NAT.</li>
    <li>Также теряется сквозная трассировка IPv4. Сложнее трассировать пакеты, которые подвергаются многочисленным изменениям адресов пакетов в течение нескольких NAT-переходов, что затрудняет поиск и устранение неполадок.</li>
    <li>Использование NAT также затрудняет протоколы туннелирования, такие как IPsec, поскольку NAT изменяет значения в заголовках, которые мешают проверкам целостности, выполняемым IPsec и другими протоколами туннелирования.</li>
    <li>Службы, требующие инициирования TCP-соединений из внешней сети, или stateless протоколы, например, использующие UDP, могут быть нарушены. Если маршрутизатор NAT не настроен для поддержки таких протоколов, входящие пакеты не могут достичь своего адресата.</li>
</ul>
