Нюансы работы с вещественными числами
<p>----------------------------------------</p>
Округление вещественных чисел Как мы уже разбирали, при присваивании переменной типа int вещественного числа оно всегда округляется вниз до целого – его дробная часть просто отбрасывается. А ведь легко можно представить ситуацию, когда дробное число нужно округлить просто до ближайшего целого ил
<p>----------------------------------------</p>
<h2>1. Округление вещественных чисел</h2>
<p>Как мы уже разбирали, при присваивании переменной типа <code>int</code> вещественного числа оно всегда округляется вниз до целого — его дробная часть просто отбрасывается.</p>
<p>А ведь легко можно представить ситуацию, когда дробное число нужно округлить просто до ближайшего целого или вообще вверх. Что делать в этой ситуации?</p>
<p>Для этого и для многих похожих случаев в Java есть класс <code>Math</code>, у которого есть методы <code>round()</code>, <code>ceil()</code>, <code>floor()</code>.</p>
<hr>
<p><strong>Метод <code>Math.round()</code></strong></p>
<p>Метод <code>Math.round()</code> округляет число до ближайшего целого:</p>
<div class="lesson-example lesson-example--center">
    <pre class="lecture-code lecture-code--present language-java"><code>long <span class="code text-green">x</span> = Math.round(<span class="code text-user">вещественное_число</span>)</code></pre>
</div>
<p>Но, как говорится, есть нюанс: результат работы этого метода — целочисленный тип <code>long</code> (не <code>int</code>). Вещественные числа ведь могут быть очень большими, поэтому разработчики Java решили использовать самый большой целочисленный тип, который есть в Java — <code>long</code>.</p>
<p>Поэтому чтобы присвоить результат в переменную типа <code>int</code>, программист должен явно указать компилятору, что он согласен с возможной потерей данных (вдруг число не поместится в тип <code>int</code>).</p>
<div class="lesson-example lesson-example--center">
    <pre class="lecture-code lecture-code--present language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.round(<span class="code text-user">вещественное_число</span>)</code></pre>
</div>
<p>Примеры:</p>
<table>
    <tbody>
    <tr>
        <th width="70%">Команда</th>
        <th class="text-center">Результат</th>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.round(<span class="code text-user">4.1</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>4</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.round(<span class="code text-user">4.5</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>5</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.round(<span class="code text-user">4.9</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>5</code></pre>
        </td>
    </tr>
    </tbody>
</table>
<p><strong>Метод <code>Math.ceil()</code></strong></p>
<p>Метод <code>Math.ceil()</code> округляет число до целого <span class="text-bold">вверх</span>, примеры:</p>
<table>
    <tbody>
    <tr>
        <th width="70%">Команда</th>
        <th class="text-center">Результат</th>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.ceil(<span class="code text-user">4.1</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>5</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.ceil(<span class="code text-user">4.5</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>5</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.ceil(<span class="code text-user">4.9</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>5</code></pre>
        </td>
    </tr>
    </tbody>
</table>
<p><strong>Метод <code>Math.floor()</code></strong></p>
<p>Метод <code>Math.floor()</code> округляет число до целого <span class="text-bold"> вниз</span>, примеры:</p>
<table>
    <tbody>
    <tr>
        <th width="70%">Команда</th>
        <th class="text-center">Результат</th>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.floor(<span class="code text-user">4.1</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>4</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.floor(<span class="code text-user">4.5</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>4</code></pre>
        </td>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> Math.floor(<span class="code text-user">4.9</span>);</code></pre>
        </td>
        <td>
            <pre class="text-center"><code>4</code></pre>
        </td>
    </tr>
    </tbody>
</table>
<p>Хотя, для округления числа до целого <span class="text-bold">вниз</span>, будет проще использовать просто оператор приведения типа — <code>(int)</code>:</p>
<table>
    <tbody>
    <tr>
        <th width="70%">Команда</th>
        <th class="text-center">Результат</th>
    </tr>
    <tr>
        <td>
            <pre class="language-java"><code>int <span class="code text-green">x</span> = <span class="text-red">(int)</span> <span class="code text-user">4.9</span></code></pre>
        </td>
        <td>
            <pre class="text-center"><code>4</code></pre>
        </td>
    </tr>
    </tbody>
</table>
<p>Если вам сложно запомнить эти команды, вам поможет небольшой урок английского:</p>
<ul>
    <li><code>Math</code> — математика</li>
    <li><code>Round</code> — круг/округлять</li>
    <li><code>Ceiling</code> — потолок</li>
    <li><code>Floor</code> — пол</li>
</ul>
<hr>
<div class="task-widget-container" showCover="true" taskKey="com.javarush.task.pro.task04.task0417"></div>
<div class="task-widget-container" showCover="true" taskKey="com.javarush.task.pro.task04.task0418"></div>
<hr>
<h2>2. Устройство чисел с плавающей точкой</h2>
<p>Тип <code>double</code> может хранить значения в диапазоне <code>-1.7*10<sup class="text-user">308</sup></code> до <code>+1.7*10<sup class="text-user">308</sup></code>. Такой гигантский диапазон значений (по сравнению с типом <code>int</code>) объясняется тем, что тип <code>double</code> (как и <code>float</code>) устроен совсем иначе по сравнению с целыми типами. Каждая переменная типа <code>double</code> содержит два числа: первое называется <span class="term"><span class="text-red">мантисса</span></span>, а второе — <span class="term"><span class="text-user">степень</span></span>.</p>
<p>Допустим, у нас есть число <code>123456789</code>, и мы сохранили его в переменную типа <code>double</code>. Тогда число будет преобразовано к виду <code>1.<span class="text-red">23456789</span>*10<sup class="text-user">8</sup></code>, и внутри типа <code>double</code> будут храниться два числа — <code><span class="text-red">23456789</span></code> и <code><span class="text-user">8</span></code>. Красным выделена «значащая часть числа» (манти&#x301;сса), синим — степень.</p>
<p>Такой подход позволяет хранить как очень большие числа, так и очень маленькие. Но т.к. размер числа ограничен 8 байтами (64 бита) и часть бит используется под хранение
    <span class="term"><span class="text-user">степени</span></span> (а также знака числа и знака степени), максимальная длина
    <span class="term"><span class="text-red">мантиссы</span></span> ограничена <span class="text-bold">15 цифрами</span>.</p>
<p>Это очень <span class="text-bold">упрощенное</span> описание устройства вещественных чисел, более полное можно найти <a href="https://javarush.com/groups/posts/2136-ustroystvo-vejshestvennihkh-chisel">по ссылке</a>.</p>
<hr>
<h2>3. Потеря точности при работе с вещественными числами</h2>
<p>При работе с вещественными числами всегда нужно иметь в виду, что <span class="term text-user">вещественные числа</span> <span class="text-bold">не точные</span>. Всегда будут <span class="term text-red">ошибки округления</span>, <span class="term text-red">ошибки преобразования</span> из десятичной системы в двоичную и, наконец, самое частое &#8211; <span class="term text-red">потеря точности</span> при сложении/вычитании чисел слишком разных размерностей.</p>
<p>Последнее — самая неожиданная ситуация для новичков в программировании.</p>
<p>Если из числа <code>10<sup>9</sup></code> вычесть <code>1/10<sup>9</sup></code>, мы получим опять <code>10<sup>9</sup></code>.</p>
<table>
    <tbody>
    <tr>
        <th>Вычитание чисел слишком разных размерностей</th>
        <th>Объяснение</th>
    </tr>
    <tr>
        <td>
<pre class="language-java"><code class="text-right"> 1<span class="text-orange">000000000</span>.<span class="text-orange">000000</span>000;
<sup>-</sup>         0.000000<span class="text-gray">001</span>;
 1<span class="text-orange">000000000</span>.<span class="text-orange">000000</span>000;</code></pre>
        </td>
        <td>Второе число <span class="text-bold">слишком маленькое</span>, и его значащая часть игнорируется (выделено серым). Оранжевым выделены <span class="text-orange">15 значащих цифр</span>.</td>
    </tr>
    </tbody>
</table>
<p>Что тут сказать, программирование — это не математика.</p>
<hr>
<h2>4. Опасность сравнения вещественных чисел</h2>
<p>Еще одна опасность подстерегает программистов при сравнении вещественных чисел. Т.к. при работе с этими числами могут накапливаться ошибки округления, то возможны ситуации, когда вещественные числа должны быть равны, но они не равны. И наоборот: числа должны быть не равны, но они равны.</p>
<p>Пример:</p>
<table>
    <tbody>
    <tr>
        <th width="47%">Команда</th>
        <th>Пояснение</th>
    </tr>
    <tr>
        <td>
<pre class="language-java"><code><span>double</span> <span class="code text-green">a</span> = <span class="code text-user">1000000000.0</span>;
<span>double</span> <span class="code text-green">b</span> = <span class="code text-user">0.000000001</span>;
<span>double</span> <span class="code text-green">c</span> = <span class="code text-green">a</span> - <span class="code text-green">b</span>;</code></pre>
        </td>
        <td>
            В переменной <code class="text-green">a</code> будет значение <code>1000000000.0</code><br>
            В переменной <code class="text-green">c</code> будет значение <code>1000000000.0</code><br>
            (число в переменной <code class="text-green">b</code> слишком маленькое)
        </td>
    </tr>
    </tbody>
</table>
<p>В приведенном выше примере <code class="text-green">a</code> и <code class="text-green">c</code> не должны быть равны, но они равны.</p>
<p>Или возьмем другой пример:</p>
<table>
    <tbody>
    <tr>
        <th width="47%">Команда</th>
        <th>Пояснение</th>
    </tr>
    <tr>
        <td>
<pre class="language-java"><code><span>double</span> <span class="code text-green">a</span> = 1.<span class="text-orange">000000000000000</span><span class="text-gray">01</span>;
<span>double</span> <span class="code text-green">b</span> = 1.<span class="text-orange">000000000000000</span><span class="text-gray">02</span>;</code></pre>
        </td>
        <td>
            В переменной <code class="text-green">a</code> будет значение <code>1.0</code><br>
            В переменной <code class="text-green">b</code> будет значение <code>1.0</code>
        </td>
    </tr>
    </tbody>
</table>
<hr>
<h2 id="strictfp-story">5. Интересный факт о <code>strictfp</code></h2>
<p>В Java есть специальное ключевое слово <code>strictfp</code> (<span class="term"><strong>strict</strong> <strong>f</strong>loating <strong>p</strong>oint</span>), которого нет в других языках программирования. И знаете, зачем оно нужно? Оно <span class="text-red">ухудшает</span> точность работы с вещественными числами. История его появления примерно такова:</p>
<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Создатели Java:</div>
        <div class="lesson-speech-bubble__message">
            Мы очень хотим, чтобы Java была суперпопулярна, и программы на Java выполнялись на как можно большем количестве устройств. Поэтому мы прописали в спецификацию Java-машины, что на всех типах устройств все программы должны выполняться <strong>одинаково</strong>!
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--right">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Создатели процессора Intel:</div>
        <div class="lesson-speech-bubble__message">
            Ребята, мы улучшили наши процессоры, и теперь все вещественные числа внутри процессора будут представлены не 8-ю, а 10-ю байтами. Больше байт — больше знаковых цифр. А это значит что? Правильно: теперь ваши научные вычисления будут еще более точными!
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--right">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Ученые и все, кто занимается сверхточными расчетами:</div>
        <div class="lesson-speech-bubble__message">
            Круто! Молодцы. Отличная новость.
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Создатели Java:</div>
        <div class="lesson-speech-bubble__message">
            Не-не-не, ребята. Мы же сказали: все Java-программы должны выполняться <strong>одинаково на всех устройствах</strong>. Принудительно выключаем возможность использования 10 байтовых вещественных чисел внутри процессоров Intel.
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__message">
            Вот теперь все опять отлично! Не благодарите.
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--right">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Ученые и все, кто занимается сверхточными расчетами:</div>
        <div class="lesson-speech-bubble__message">
            Да вы там совсем охренели? Ану быстро вернули все как было!
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Создатели Java:</div>
        <div class="lesson-speech-bubble__message">
            Ребята, это для вашей же пользы! Только представьте: все Java-программы выполняются <strong>одинаково на всех устройствах</strong>. Ну круто же!
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--right">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Ученые и все, кто занимается сверхточными расчетами:</div>
        <div class="lesson-speech-bubble__message">
            Нет. Совсем не круто. Быстро вернули все обратно! Или мы вашу Java вам знаете куда засунем?
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__name">Создатели Java:</div>
        <div class="lesson-speech-bubble__message">
            Гм. Что же вы сразу не сказали. Конечно, вернем.
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__message">
            Вернули возможность пользоваться всеми фичами крутых процессоров.
        </div>
    </div>
</div>

<div class="lesson-speech-bubble lesson-speech-bubble--left">
    <div class="lesson-speech-bubble__container">
        <div class="lesson-speech-bubble__message">
            Кстати. Мы так же специально добавили в язык слово <code>strictfp</code>: если его написать перед именем функции, вся работа с вещественными числами внутри этой функции будет <span class="text-red">одинаково плохой на всех устройствах</span>!
        </div>
    </div>
</div>