Основные задачи при проектировании баз данных
<p>----------------------------------------</p>
Обеспечение хранения в БД всей необходимой информации
Обеспечение возможности получения данных по всем необходимым запросам
Сокращение избыточности и дублирования данных
Обеспечение целостности базы данных
Оптимизация скорости доступа к данным
<p>----------------------------------------</p>
<h2>1.1 Введение</h2>
<p>Проектирование базы данных чем-то похоже на создание архитектуры Java-проекта. Вы можете поместить все данные в пару таблиц, а можете выстроить красивую структуру данных из схем и десятков таблиц. </p>
<p>Вот какие задачи обычно стоят перед разработчиком при проектировании базы данных: </p>
<ol>
	<li>Обеспечение хранения в БД всей необходимой информации.</li>
	<li>Обеспечение возможности получения данных по всем необходимым запросам.</li>
	<li>Сокращение избыточности и дублирования данных.</li>
	<li>Обеспечение целостности базы данных</li>
	<li>Оптимизация скорости доступа к данным</li>
</ol>
<p>Главное помните, нельзя сделать идеальную структуру базы данных, т.к. она, как и ваш код, тоже будет постоянно меняться. При проектировании структуры базы данных вы должны помнить три вещи:</p>
<ol>
	<li>Структура должна быть достаточно хорошей. </li>
	<li>Во всем должна быть логика, понятная другим людям. </li>
	<li>Преждевременная оптимизация – корень всех зол. </li>
</ol>
<p><strong>Не нужно</strong> делать лучшую в мире структуру базы данных. Она все равно будет меняться. Ваша задача следить за тем, чтобы после 20 изменений структуры вашей базы, в ней было достаточно просто разобраться. </p>
<p>Скорее всего в первые годы вашей работы никто не доверит вам спроектировать базу с нуля. Вы будете вносить изменения в уже существующую схему. Вам нужно постараться понять на основе каких принципов она устроена и <strong>придерживаться их же</strong>. Со своим уставом в чужой монастырь не лезут. 
</p>
<p><strong>Не занимайтесь оптимизацией базы данных</strong>, пока это не нужно. Если в таблице всего пара сотен строк, то скорее всего СУБД будет держать ее в памяти и кешировать запросы к ней.  
</p>
<p>С другой стороны, вы должны уметь ускорить работу важных запросов в десятки, а то и сотни раз. И хорошо бы вам знать, как это делается. Как там говорят в вузе на первом курсе? «Забудьте все, чему вас учили в школе…» 
</p>
<p>Если вы знаете, что такое нормализация баз данных, то спешу вас обрадовать, в своей работе вы скорее всего будете заниматься <strong>де-нормализацией</strong>. Для заказников проекта нет ничего важнее скорости работы базы данных. И если для того, чтобы ускорить выборку данных из базы нужно объединить 200(!) таблиц в одну (с чудовищной избыточностью), вам придется это сделать.</p>
<h2>1.2 Проектирование библиотеки</h2>
<p>Давайте, чтобы немного погрузиться в предметную область, поразмышляем над проектированием базы данных на таком простом примере, как работа обычной книжной библиотеки.</p>
<p>Основная задача любой библиотеки — обработка книжного фонда. Нетрудно выделить три основные группы пользователей системы: <strong>читатель, библиотекарь, администратор</strong>. Деятельность каждого из них показана на диаграмме вариантов использования. </p>
<img data-max-width="512" data-id="5c1ceca8-4c3a-47e2-81ce-cf458cfb1dad" src="https://cdn.javarush.com/images/article/5c1ceca8-4c3a-47e2-81ce-cf458cfb1dad/512.jpeg" alt="">
<p>Уже сейчас можно выделить некоторые сущности и отношения будущей базы данных: </p>
<img data-max-width="800" data-id="3b8a6e54-4dcb-48a9-afe9-dd588efe8906" src="https://cdn.javarush.com/images/article/3b8a6e54-4dcb-48a9-afe9-dd588efe8906/800.jpeg" alt="">
<p>При таком подходе не понятно, как именно связать читателя с книгой (у читателя не проставлена арность в отношении «выдача/прием». Если книга имеет несколько экземпляров — то она может быть выдана нескольким читателям. Даже если же под книгой понимать один экземпляр — то при сохранении в таблице книг текущего читателя приведет к невозможности получения информации о том, кто (и сколько раз) брал эту книгу ранее. </p>
<p>Решением может быть <strong>введение дополнительной сущности</strong> — карточки о выдаче книги. При выдаче книги читателю заводится карточка, а при сдаче книги — в нее ставится соответствующая пометка. С помощью этих карточек определяются задолженности каждого пользователя и вычисляется статистика использования книг. 
При бронировании литературы читателем — также заводится карточка, если забронированная литература не взята читателем в определенный срок — карточка уничтожается. Существует ограничение на количество книг, которые может забронировать читатель. </p>
<p>При подборе литературы пользователь просматривает каталог литературы с возможностью фильтрации результатов поиска по автору, названию, году издания.</p>
<p>Есть возможность расчета статистики по всем книгам библиотеки, при этом количество выданных экземпляров книги за заданный период времени. Также можно задать минимальное число экземпляров книг, для которых выполняется расчет. На основании этой статистики производится списание неиспользуемых книг из библиотеки.</p>
<p>Можно выделить следующие основные сущности предметной области: </p>
<ul>
	<li><strong>пользователь</strong> (библиотекари и администраторы);</li>
	<li><strong>читатель; </strong></li>
	<li><strong>читальный зал;</strong></li>
	<li><strong>книга; </strong></li>
	<li><strong>карточка выдачи книги;</strong></li>
	<li><strong>карточка бронирования книги.</strong></li>
</ul>
<p>Доработанная ER- диаграмма базы данных приведена на рисунке.</p>
<img data-max-width="800" data-id="911e9c95-c3bb-467c-8a86-8c6a4e487b98" src="https://cdn.javarush.com/images/article/911e9c95-c3bb-467c-8a86-8c6a4e487b98/800.jpeg" alt="">
<p>В соответствии с прецедентами, показанными на рисунке 1, база данных должна реализовывать, следующие запросы (не полный перечень): </p>
<ul>
	<li>отобразить книги, соответствующие заданным условиям; </li>
	<li>отобразить пользователей, имеющих незакрытые вовремя карточки выдачи книг (библиотекарь ищет должников);</li>
	<li>отобразить все книги, соответствующие незакрытым вовремя карточкам выдачи книг заданного пользователя (пользователь пришел в библиотеку за новыми книгами — надо посмотреть является ли он должником и сообщить ему об этом); </li>
	<li>удалить все карточки бронирования, созданные более чем N секунд назад; </li>
	<li>отобразить все книги, соответствующие незакрытым карточкам бронирования книг заданного пользователя (читатель заказал книги и пришел в библиотеку за ними — библиотекарю надо получить этот список чтобы выдать). 
</li>
</ul>
<h2>1.3 Формирование схемы данных </h2>
<p>Для формирования схемы данных необходимо сначала дополнить ER-диаграмму реквизитами сущностей (уточнить ее). Иногда, при этом удается найти ошибки построения ER-диаграммы — в этой задаче было обнаружено, что книгу необходимо «как-то» связать с залом библиотеки.  
</p>
<p>Сделать это можно, поместив в книгу реквизит «номер зала», однако при таком подходе одну и ту же книгу придется описывать в базе несколько раз (если она встречается в разных залах). Более правильный подход заключается во введении дополнительной сущности «размещение книги». На рисунке показана ER-диаграмма с добавленной сущностью и реквизитами. </p>
<img data-max-width="1024" data-id="dce386c9-1721-4c73-b71f-fae67df02985" src="https://cdn.javarush.com/images/article/dce386c9-1721-4c73-b71f-fae67df02985/1024.jpeg" alt="">
<p>Приведенная ER-диаграмма отражает основные таблицы, связи и атрибуты, на ее основе можно построить модель БД. На ER-диаграммы нет стандарта, но есть ряд нотаций (Чена, IDEFIX, Мартина и т.п.), но на модель предметной области не удалось найти ни стандарта, ни нотаций. Однако, в ходе построения такой диаграммы обязательно выделяются ключевые поля (внешние и внутренние), иногда — индексы и типы данных. </p>
<p>При этом на следующей схеме: </p>
<ul>
	<li>для связей используется нотация Мартина («вороньи лапки»);</li>
	<li>таблицы изображены прямоугольниками, разделенными на 3 секции: </li>
		<ul>
			<li>имя таблицы;</li>
			<li>внутренние ключи (помечаются маркером); </li>
			<li>остальные поля, при этом обязательные помечаются маркером. </li>
		</ul>
		<p><img data-max-width="800" data-id="be301feb-d3ec-48e3-8eb1-a5a7de7a353a" src="https://cdn.javarush.com/images/article/be301feb-d3ec-48e3-8eb1-a5a7de7a353a/800.jpeg" alt=""></p>
</ul>
<p>При разработке этой модели возникало желание объединить таблицу администраторов с таблицей библиотекарей — добавить таблицу users, однако: </p>
<ul>
	<li>администратор не связан с конкретным залом (пришлось бы заполнять соответствующее поле null-значениями);</li>
	<li>вероятно, это осложнило бы распределение прав доступа — сейчас доступ к таблице administrators имеет только администратор базы данных (работающий через специальную панель СУБД и не имеющий учетной записи в разрабатываемой системе). Однако при соединении таблиц пользовательские запросы требовали бы доступа к новой таблице.</li>
</ul>
<p>При построении этой диаграммы был найден и исправлен недочет ER-диаграммы — добавлена таблица <code>librarians_rooms</code>, объединяющая библиотекарей и залы. Это нужно, так как один библиотекарь может работать в нескольких залах, но несколько библиотекарей могут работать в одном и том же зале. </p>
<p>При проектировании баз данных вы должны уметь рассуждать хотя бы так, как в приведенном выше примере. Если вы считаете, что у вас это получилось – пойдем дальше: еще больше теории.</p>
