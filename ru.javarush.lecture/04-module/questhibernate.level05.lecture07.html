Бэкап данных
<p>----------------------------------------</p>
Необходимость бэкапа базы данных
Создание бэкапа базы данных
Создание бэкапа схемы таблиц
Создание бэкапа данных
Развертывание бэкапа
<p>----------------------------------------</p>
<h2>8.1 Необходимость бэкапа базы данных</h2>
<p>Ты научился создавать схемы баз данных, таблицы, просматривать их. Также заполнять эти таблицы данными и менять их. Теперь тебе нужно научиться самому главному – делать бэкапы.</p>
<p>Базу данных очень легко сломать. Дело в том, что база данных обычно находится в состоянии постоянных изменений: в нее постоянно что-то сохраняется и добавляется.</p>
<p>Вот представь, что у тебя в браузере открыта вкладка и ты не хочешь, чтобы информация в ней потерялась. Согласись, что если ты просто решишь никогда ее не закрывать, то это будет не самый лучший вариант. Ведь браузер может зависнуть, его можно закрыть случайно, у тебя может пропасть свет или сгореть компьютер. Windows может установить очередной апдейт, да мало ли что.</p>
<p>Так вот, твоя база данных – это такая же вкладка. И это только дело времени, когда при очередной записи на диск что-то пойдет не так. Поэтому тебе обязательно нужно научиться делать бэкапы.</p>
<p>Делать бэкапы – это как чистить зубы, у нормальных компаний еженощно делается бэкап содержимого каждой базы данных. А так как жесткие диски тоже могут выходить из строя и в датацентрах бывают пожары, то бэкапы обычно сохраняются в 2-3 копиях в датацентрах в разных частях мира.</p>
<p>Есть несколько подходов к созданию бэкапа.</p>
<p><strong>Бэкап файлов. </strong>Так как все <span class="text-green">данные базы данных хранятся на диске в виде набора файлов</span>, то самый простой способ – это просто скопировать эті файлы куда-нибудь. Или сперва заархивировать в один архив, а потом куда-нибудь скопировать.</p>
<p>Это самый быстрый способ сделать бэкап, но он требует, чтобы файлы не менялись во время их копирования/архивирования. Базу нужно заморозить на время создания копии, иначе копия будет кривая. Ведь может быть ситуация, что часть новых данных записалась в базу, а часть – еще нет.</p>
<p><strong>Бэкап в виде SQL-запросов</strong>. Как ты уже знаешь, добавление и изменение данных в базе SQL-сервера всегда представляет в виде SQL-запросов. Так что можно попросить SQL-сервер, чтобы он сохранил содержимое определенной таблицы или таблиц в файл в виде SQL-запросов.</p>
<p>Этот способ медленнее, чем предыдущий, зато с его помощью можно переносить данные между SQL-серверами разных производителей.</p>
<p>Кроме того, не все данные всегда нужно сохранять. Часто у тебя в таблицах есть куча служебной или устаревшей информации и можно указать SQL-серверу, чтобы он ее не сохранял.</p>
<p>Также для таблиц, которые хранят какие-то события с привязкой ко времени, ты можешь просто делать выборку таких событий за последние сутки и хранить только их.</p>
<p><strong>Различные утилиты</strong>. Компании готовы платить кучу денег, чтобы получить гарантию, что их данные останутся в целостности и сохранности. Поэтому различные ИТ-компании начали предлагать решения на все случаи жизни. Например, есть программы, которые могут делать бэкап-базы в виде файлов и при этом не требуют, чтобы эти файлы не менялись.</p>
<p>Например, можно установить специальные драйверы в операционную систему и отслеживать, когда, что и где менялось.</p>
<h2>8.2 Создание бэкапа базы данных</h2>
<p>Workbench отлично умеет делать экспорт и импорт данных из баз с которыми работает. Для этого тебе всего лишь нужно нажать пункт меню: <code>Server-&gt; Data Export</code>. И ты увидишь примерно такую картинку:</p>
<img data-max-width="800" data-id="077c35fe-8e3b-4123-bd1b-05da4e18f8be" src="https://cdn.javarush.com/images/article/077c35fe-8e3b-4123-bd1b-05da4e18f8be/800.jpeg" alt="">
<p>А теперь добавим немного пояснений:</p>
<img data-max-width="800" data-id="f07330e8-96f1-4693-a8e5-099ccb2b63ef" src="https://cdn.javarush.com/images/article/f07330e8-96f1-4693-a8e5-099ccb2b63ef/800.jpeg" alt="">
<p>Порядок такой:</p>
<ol>
	<li>Сначала выбираем схему, или схемы, которые будет экспортировать.</li>
	<li>Затем справа указываем таблицы для бэкапа.</li>
	<li>Дальше мы должны выбрать, что именно мы будет экспортировать:</li>
		<ul>
			<li>только данные;</li>
			<li>только структуру (таблицы будет, но пустые);</li>
			<li>данные и структуру.</li>
		</ul>
	<li>Выбираем как данные сохранить:</li>
		<ul>
			<li>один файл для каждой таблицы;</li>
			<li>один файл для всех таблиц.</li>
		</ul>
	<li>Также ты можешь добавить код по созданию схемы в начало файла. Это удобно при переносе данных между разными СУБД.</li>
</ol>
<h2>8.3 Создание бэкапа схемы таблиц</h2>
<p>Давайте создадим бэкап только схемы, без непосредственно данных.</p>
<p>Я выбрал Dump Structure Only и нажал Start Export.</p>
<img data-max-width="512" data-id="bfb02fee-e4b1-46d2-8292-b1d796969d0c" src="https://cdn.javarush.com/images/article/bfb02fee-e4b1-46d2-8292-b1d796969d0c/512.jpeg" alt="">
<p>И вот что я нашел в файле, который сделал Workbench.</p>
<pre class='language-java line-numbers'><code>
<span class="token comment">--
-- Table structure for table `user`
--</span>
 
DROP TABLE IF EXISTS `user`;
/*!40101 SET @saved_cs_client 	= @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `user` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT NULL,
  `level` int(11) DEFAULT NULL,
  `created_date` date NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;
</code></pre>
<p>Все верно, это и есть схема наших таблиц, если так можно сказать про одну-единственную таблицу.</p>
<h2>8.4 Создание бэкапа данных</h2>
<p>А теперь давай сделаем бэкап только данных, но без структуры схемы.</p>
<p>Выберем Dump Data Only и посмотрим, что нам отдадут:</p>
<img data-max-width="512" data-id="23ac2770-c70f-4e18-b60b-2b9438d7bb83" src="https://cdn.javarush.com/images/article/23ac2770-c70f-4e18-b60b-2b9438d7bb83/512.jpeg" alt="">
<p>И вот что я нашел в файле, который сделал Workbench.</p>
<pre class='language-java line-numbers'><code>
<span class="token comment">--
-- Dumping data for table `user`
--</span>
 
LOCK TABLES `user` WRITE;
/*!40000 ALTER TABLE `user` DISABLE KEYS */;
INSERT INTO `user` VALUES
 	(1,'Иванов Иван',40,'2022-05-11'),
 	(2,'Петров Никола',1,'2021-05-01'),
 	(3,'Сидроов Виталий',8,'2022-05-12');
/*!40000 ALTER TABLE `user` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;
</code></pre>
<p>Да, очень похоже на правду. Также мы тут видим специальный код, который лочит таблицу user. Это сделано для того, чтобы ты мог просто выполнять данный SQL-скрипт: в нем содержатся все инструкции, которые позволят любому SQL-серверу правильно восстановить данные.</p>
<h2>8.5 Развертывание бэкапа</h2>
<p>И наконец последнее – это восстановление базы данных из бэкапа. Это Действие это очень простое, но полезное.</p>
<p>Допустим, я хочу, чтобы у всех моих студентов была определенная база данных, чтобы вы могли на ней учиться писать запросы. Тогда я просто дам вам ссылку на файл, который вы локально у себя развернете и все.</p>
<p>И даже если вы случайно удалите какие-то данные, таблицы, или даже всю схему, ее всегда можно будет восстановить из бэкапа.</p>
<p>Для того чтобы сделать Import данных нужно в меню кликнуть на пункт <code>Server-&gt; Data Import</code>. Тогда вы увидите такую картинку:</p>
<img data-max-width="800" data-id="690e1ce0-5b31-4807-8172-06c5ba1d4459" src="https://cdn.javarush.com/images/article/690e1ce0-5b31-4807-8172-06c5ba1d4459/800.jpeg" alt="">
<p>Как и в случае с экспортом сначала вам предлагают выбрать источник данных: группа файлов или все данные одним файлом.</p>
<p>Затем нужно выбрать схему, в которую будут заливаться указанные данные. Вы можете выбрать как существующую схему, так и создать новую.</p>
<p><strong>Важно!</strong> Если ваш бэкап содержит не только данные, но и описание структуры таблиц, то таблицы будут пересозданы (если таковые уже есть в целевой схеме).</p>