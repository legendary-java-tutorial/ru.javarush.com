Разбираем базы данных и язык SQL. (Часть 4 — проверка домашнего задания) - "Java-проект от А до Я"
<p>----------------------------------------</p>
Всем, у кого хватило терпения и выдержки, всем, кто идет со мной уже четвертую статью — вы молодцы. Как говорится, дорогу осилит идущий. На этой неделе выйдет заключительная статья о Базах Данных...
<p>----------------------------------------</p>
<em>Статья из серии о создании Java-проекта (ссылки на другие материалы — в конце). Ее цель — разбор ключевых технологий, итог — написание телеграм-бота.</em>

Предыдущие статьи и разбор домашнего задания по базам данных: <a href="https://javarush.com/groups/posts/2946-java-proekt-ot-a-do-ja-razbiraem-bazih-dannihkh-i-jazihk-sql" target="_blank">1</a>, <a href="https://javarush.com/groups/posts/2957-java-proekt-ot-a-do-ja-razbiraem-bazih-dannihkh-i-jazihk-sql-chastjh-2" target="_blank">2</a>, <a href="https://javarush.com/groups/posts/2977-java-proekt-ot-a-do-ja-razbiraem-bazih-dannihkh-i-jazihk-sql-chastjh-3" target="_blank">3</a>. 

Всем, у кого хватило терпения и выдержки, всем, кто идет со мной уже четвертую статью — вы молодцы. Как говорится, дорогу осилит идущий.

На этой неделе выйдет заключительная статья о Базах Данных, в которой мы поговорим о <span class="text-bold">типах связей</span> и <span class="text-bold">джоинах (соединениях)</span>.

Но перед тем, как мы разберемся с новой информацией — проверим домашнее задание… Я прям училкой себя почувствовал. Не серчайте на меня: педагогического образования у меня нет, маемо шо маемо.

Поскольку на прошлой неделе подробная проверка ДЗ заняла львиную долю материала, я решил разбить разбор домашки и обзор нового материала на две части.<img data-max-width="800" data-id="c7682c6d-1845-459f-8237-7fc50379cfa4" src="/images/article/c7682c6d-1845-459f-8237-7fc50379cfa4/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 1"><h2>Собственно, разбор домашки</h2>Я определенно рад тому, что находятся люди, которые делают ДЗ и говорят об этом. Это здорово! Я максимально уверен, что просто прочитать без закрепления знаний — это путь в никуда. Поэтому все, кто сделал или пытался сделать, — респект.

Напомню условия заданий:<ol>

<li>Разобраться с оператором <span class="text-bold">HAVING</span> и написать пример запроса для таблиц из нашего примера. Если нужно добавить какие-то поля или ещё значений, чтобы было нагляднее — добавляйте. Кто хочет — пишите в комментариях свой пример решения — так я его еще и проверить смогу, если успею.</li>
<li>Установить MySQL Workbench для работы с БД через UI. Я думаю, что мы уже достаточно практиковались работе из консоли. Подключиться к БД. Если используете что-то другое для работы с БД — смело скипайте это задание. Здесь и дальше я буду использовать только MySQL Workbench.</li>
<li>Написать запросы на получения по нашим данным:<ol type="a">
<li>самого мало/много численной страны;</li>
<li>среднее количество жителей в стране;</li>
<li>среднее количество жителей в странах, чьи имена оканчиваются на “a”;</li>
<li>количество стран, у которых население больше четырех миллионов;</li>
<li>отсортировать страны по уменьшению количества жителей;</li>
<li>отсортировать страны по имени в натуральном порядке.</li></ol></li>

</ol><h2>Поговорим о HAVING</h2>Знание оператора Having может помочь вам пройти не одно собеседование, где будут задачи на SQL. Поэтому понять его крайне важно. 

Так уж получилось, что использовать условия для агрегирующих функций (SUM, MIN, MAX, AVG) нельзя. 

К тому же, HAVING используют для полей, которые группируются.

Что это значит? Например, если мы хотим получить страны, где среднее количество жителей в городах больше 50 000 жителей, без использования HAVING нам не обойтись.

Как я понимаю, сделано это потому, что агрегация происходит уже после того, как выполнится оператор WHERE и нельзя добавить в него значения агрегации, которые будут подсчитаны позже.

Даже если пока что мои суждения не сильно добавляют понимания, можно просто принять это как факт и идти с ним. В программировании часто получается так, что если в один момент что-то непонятно, это вполне может означать, что мозг просто еще не переварил это. Переспите с этой мыслью, и на следующий день все станет яснее.<h2>Установка MySQL Workbench</h2>Здесь и далее я буду использовать именно Workbench для запросов. Покажу, что нужно для установки и создания соединения с базой данных.

Это продукт от Oracle, поэтому нужно просто пойти на их сайт и выбрать нужную версию и операционную систему. Для этого перейдем по <a href="https://dev.mysql.com/downloads/workbench/" rel="nofollow" target="_blank">этой ссылке</a>:<img data-max-width="512" data-id="9250d12f-036d-42f1-a891-58eacd5efa7f" src="/images/article/9250d12f-036d-42f1-a891-58eacd5efa7f/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 2">Здесь вы можете выбрать именно ту операционную систему, которая вам нужна. 

Нажимаем <span class="text-bold">Download</span>, но вместо загрузки мы увидим такое окно:<img data-max-width="512" data-id="74d39365-6006-4469-a951-4f16653bf0f4" src="/images/article/74d39365-6006-4469-a951-4f16653bf0f4/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 3">Не теряемся, просто ищем кнопочку с названием <span class="text-bold">No thanks, just start my download</span>, и начнется скачивание. Зачем они это делают? Наверное, чтобы больше регистрировалось у них, нам это не важно.

После успешной загрузки запускаем установочный файл. На MacOS это выглядит так:<img data-max-width="512" data-id="3398db83-cc01-4756-9732-9b18ef324b28" src="/images/article/3398db83-cc01-4756-9732-9b18ef324b28/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 4">Просто переносим значок — и все, установка завершена. Уже не так сложно, как установка самого MySQL, правда? Или уже просто привыкли и стали более опытные ;)

Вторая часть этой задачи — установить соединение с нашей базой данных. 
Что для этого нужно? Нажимаем плюсик рядом с MySQL Connections:<img data-max-width="512" data-id="fae68696-9884-4bf2-b1c4-6d85066bff6b" src="/images/article/fae68696-9884-4bf2-b1c4-6d85066bff6b/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 5">В появившемся окне вводим необходимые данные:<ul>
<li><span class="text-bold">Connection Name</span> — имя нашего соединения. Пишите максимально понятные имена, чтобы потом не было проблем с идентификацией. Я этому соединению даю имя <span class="text-bold">JRTB_DB</span>;</li>
<li><span class="text-bold">Hostname</span> — уже будет задан как локальный <span class="text-bold">127.0.0.1</span> (он же localhost). В нашем случае ничего менять не нужно, так как БД установлена на компьютере, а вот если БД где-то в другом месте, то и хост (ip той машины, на которой запущена БД), соответственно, изменить нужно;</li>
<li><span class="text-bold">Username</span> — также по необходимости можно задавать своего юзера. Если вы не добавляли ничего в этом ключе, оставьте его неизменным;</li>
<li><span class="text-bold">Password</span> — нажимаем <span class="text-bold">Store in Keychain</span> и задаем именно тот пароль, который вы задавали у себя. Я оставил все по-простому — <span class="text-bold">root</span>.</li>

</ul>Чтобы проверить, будет ли соединение, нажимаем <span class="text-bold">Test Connection</span>:<img data-max-width="512" data-id="00b6c846-3a75-4f29-bc5d-f55bad1505b5" src="/images/article/00b6c846-3a75-4f29-bc5d-f55bad1505b5/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 6">Ну и если все сделано было правильно, результат не заставит себя ждать:<img data-max-width="512" data-id="78bc380b-66be-49cc-bf65-cfe4681bf53a" src="/images/article/78bc380b-66be-49cc-bf65-cfe4681bf53a/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 7">Теперь у нас есть сохраненное соединение в БД, и не нужно будет каждый раз создавать соединение, заполнять имя и пароль. И будет выглядеть это счастье вот так:<img data-max-width="512" data-id="eae68182-d0d9-4e75-8e16-cd63ee977c53" src="/images/article/eae68182-d0d9-4e75-8e16-cd63ee977c53/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 8">Заходим в только что созданное соединение и видим окно для запросов. Чтобы быть уверенным, что все правильно, проверим список баз данных, зайдем в нашу и получим все данные о городах:<img data-max-width="800" data-id="af150939-ff1c-48d2-b15e-b7c8c239e00a" src="/images/article/af150939-ff1c-48d2-b15e-b7c8c239e00a/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 9">Причем здесь мы получаем картбланш на то, что нам нужно. Первая секция отвечает за скрипт, который мы вводим. Далее, в <span class="text-bold">Result Grid</span>, мы видим результат последней операции в скрипте. А в <span class="text-bold">Action Output</span> показан список операций и его результат. Очень полезная вещь, хочу я вам сказать: с ее помощью можно следить за скоростью выполнения определенных скриптов. 

Почему это важно? Одна из самых распространенных проблем в скорости выполнения задач в приложении — это скорость выполнения запросов в БД. Здесь их можно будет быстро и удобно проверить руками.<h2>Пишем необходимые запросы</h2>У нас всего 7 запросов, которые нужно выполнить, поехали!<h3><ol><li>Получить самую многочисленную страну. Здесь можно пойти хитро и несколькими маршрутами:</li></ol></h3><h4><ul><li>По данным таблицы country</li></ul></h4>Тогда необходимо просто отсортировать наш запрос по населению и взять только одну запись. Для этого дела в конце скрипта нужно добавить оператор <span class="text-bold">LIMIT</span> и указать необходимое количество:

<span class="text-bold">$ SELECT * FROM country ORDER BY population DESC LIMIT 1;</span><img data-max-width="800" data-id="99a6c791-8b5f-4b3f-aeff-4ca690cc60cf" src="/images/article/99a6c791-8b5f-4b3f-aeff-4ca690cc60cf/512.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 10"><h4><ul><li>По данным таблицы city</li></ul></h4>Здесь все интереснее, потому что запрос будет сложнее, но и интереснее. Так как мы еще не имеем понятия о джоинах, можем получить только ID-шник страны:

<span class="text-bold">$ SELECT country_id, SUM(population) FROM city GROUP BY country_id ORDER BY SUM(population) DESC LIMIT 1;</span><img data-max-width="800" data-id="df4aa113-e17d-4e34-a020-992555c071bf" src="/images/article/df4aa113-e17d-4e34-a020-992555c071bf/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 11">Здесь мы сделали прикольную вещь — собрали сумму населения всех известных городов по каждой стране, отсортировали по этой сумме и взяли первый элемент. 

Ну как, здорово? Я вот в восторге :D После такого сразу ощущаешь себя гуру запросов… (ненадолго, конечно))<h3><ol start="2"><li>Получить самую малочисленную страну. Здесь можно пойти хитро и несколькими маршрутами</li></ol></h3>В этом случае все будет ровно так же. Разница лишь в том, что сортировать будет обратно — и все. Поэтому просто пишу запросы:<h4><ul><li>По данным таблицы city</li></ul></h4><span class="text-bold">$ SELECT country_id, SUM(population) FROM city GROUP BY country_id ORDER BY SUM(population) LIMIT 1;</span><h4><ul><li>По данным таблицы country</li></ul></h4><span class="text-bold">$ SELECT * FROM country ORDER BY population LIMIT 1;</span>

А результат уже посмотрите сами!<h3><ol start="3"><li>Среднее количество жителей в стране</li></ol></h3>Вот опять ТЗ стоит как-то не точно, как будто писал менеджер... Почему я так решил? Потому что неясно, в какой таблице работать. Но это нормально: задач, в которых будет сразу все понятно и ясно, просто не бывает. Поэтому нужно внимательно вчитываться в задачи, и если есть вопросы — сразу задавать их! Это так, ремарка.

С учетом данных, которые есть у нас в БД, будем искать по данным из городов.

Для этого пишем следующий запрос:

<span class="text-bold">$ SELECT country_id, AVG(population) FROM city GROUP BY country_id;</span><img data-max-width="800" data-id="bf4d178f-f905-4dde-96a5-8a3cf326f389" src="/images/article/bf4d178f-f905-4dde-96a5-8a3cf326f389/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 12">Здесь все просто: мы используем функцию AVG и группируем наши записи городов по странам.<h3><ol start="4"><li>Среднее количество жителей в странах, чьи имена заканчиваются на “a”</li></ol></h3>Здесь будет небольшое изменение по запросу. Нужно добавить фильтрацию по именам, прежде чем мы будем делать группировку. Делаю я домашку, как и все студенты, перед публикацией этой статьи, и понимаю, что без джоинов эту задачу не решить. Почему? Потому что помимо ID-шника страны нам нужно еще получить его имя. А это нельзя сделать без соединения двух таблиц в одну запись.

Поэтому я сделаю эту задачу, конечно, но это мой косяк…))) Хотел придумать задачу с использованием LIKE в запросе…)

<span class="text-bold">$ SELECT ci.country_id, AVG(ci.population) FROM city ci INNER JOIN country co ON ci.country_id = co.id WHERE co.name LIKE "%a" GROUP BY country_id;</span><img data-max-width="800" data-id="b35ae8df-ab6a-45f6-8e3e-eb0d3d4946f6" src="/images/article/b35ae8df-ab6a-45f6-8e3e-eb0d3d4946f6/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 13">Что здесь произошло? Вначале мы соединили записи с таблицы city и country по внешнему ключу country_id, отфильтровали по именам стран, чтобы они заканчивались на “a”, и уже потом группировали по country_id.<h3><ol start="5"><li>Количество стран, у которых население больше четырех миллионов</li></ol></h3>Здесь нам нужно просто использовать функцию COUNT и добавить фильтрацию на население:

<span class="text-bold">$ SELECT COUNT(*) from country WHERE population &gt; 4000000;</span>

В результате узнаем, что таких стран 3. Правильно ли это? Да, только Молдова не проходит этот рубеж.<h3><ol start="6"><li>Отсортировать страны по уменьшению количества жителей</li></ol></h3>Чтобы сделать это, нужно использовать уже известный нам оператор ORDER BY. Но учтите, что по умолчанию сортировка идёт в натуральном порядке. Для чисел это значит, что сортируется по возрастанию, для строк — что начиная с первых символов.

Если нам нужна сортировка по убыванию, нам нужен обратный от натурального:

<span class="text-bold">$ SELECT * FROM country ORDER BY population DESC;</span><img data-max-width="800" data-id="8c56e15d-e010-4d05-8f3e-8cd6f1a2616e" src="/images/article/8c56e15d-e010-4d05-8f3e-8cd6f1a2616e/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 14"><h3><ol start="7"><li>Отсортировать страны по имени в натуральном порядке</li></ol></h3>Вот здесь нам и пригодятся знания того, что такое натуральный порядок. Так как он по умолчанию, для нас это проще простого:

<span class="text-bold">$ SELECT * FROM country ORDER BY name;</span><img data-max-width="800" data-id="1a073589-9eaa-4e25-ad10-2b6fcbd8e9f9" src="/images/article/1a073589-9eaa-4e25-ad10-2b6fcbd8e9f9/800.jpeg" alt="&quot;Java-проект от А до Я&quot;: разбираем базы данных и язык SQL. Часть 4 — проверка домашнего задания - 15"><h4>Вместо вывода</h4>Так уж получилось, что размер решения домашнего задания получится очень большой, поэтому мы сделаем исключение: я публикую эту статью с проверкой, а в пятницу опубликую новый материал со связями и джоинами. 

Всем спасибо за прочтение. До пятницы!

<h4><a href="https://javarush.com/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всех материалов серии в начале этой статьи.</a></h4>