Введение в SpotBugs: инструмент для статического анализа кода
<p>----------------------------------------</p>
Разработчики остро нуждаются в том, чтобы кто-то проверял их код. Особенно это касается начинающих разработчиков. Но иногда проверка чужого кода занимает очень много времени, да и занятие это...
<p>----------------------------------------</p>
Разработчики остро нуждаются в том, чтобы кто-то проверял их код. Особенно это касается начинающих разработчиков. 

Но иногда проверка чужого кода занимает очень много времени, да и занятие это скучноватое. Однако игнорировать этот аспект разработки нельзя, ведь он напрямую влияет на качество продукта, да и на качество вас как разработчика в целом.

<img data-max-width="800" data-id="a7cc2c65-0a1b-4677-abcb-89cd3e4f1681" src="https://cdn.javarush.com/images/article/a7cc2c65-0a1b-4677-abcb-89cd3e4f1681/800.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 1">Поэтому ревью кода — обязательная часть разработки. Чтобы облегчить эту задачу, используются различные средства для <span class="text-bold">статического анализа кода</span>. Об одном из них мы поговорим сегодня.

Для начала уточним один момент. У нас уже есть Java-компилятор, который проверяет код, так в чем же его отличие от статического анализа?

<span class="text-bold">Статический анализ</span> проверяет байт-код Java (скомпилированные файлы с расширением .class) на наличие шаблонных ошибок, в то время как компилятор <span class="text-bold">Java</span> лишь проверяет исходный код на наличие синтаксических ошибок.

Такие средства помогают находить плохие решения, неиспользуемый код, неэффективные решения, возможные ошибки и т.д.

Они облегчают жизнь ревьюеров кода и позволяют отлавливать то, что они могут пропустить или не учесть при проверке.

Если вы совсем новичок и ещё не работаете в компании на проекте, данные инструменты вам будут особенно полезны, так как они будут освещать недостатки вашего кода, и вы будете их подсознательно запоминать, чтобы в будущем не допускать повтора. Ну а впоследствии вы сами сможете стать крутым ревьюером, поскольку будете мгновенно замечать все недостатки кода.

Сегодня проведем небольшой обзор статического анализатора <span class="text-bold">SpotBugs</span>.<img data-max-width="512" data-id="b3842d00-0c9b-4ed5-be17-b381116a3219" src="https://cdn.javarush.com/images/article/b3842d00-0c9b-4ed5-be17-b381116a3219/512.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 2"><a href="https://spotbugs.github.io/" rel="nofollow" target="_blank">SpotBugs</a> — это инструмент, который позволяет исследовать код для поиска возможных проблем. Он производит статический анализ, просматривая код, чтобы найти определенные <a href="https://javarush.com/groups/posts/2622-chto-takoe-antipatternih-razbiraem-primerih-chastjh-1" target="_blank">антипаттерны</a>, которые могут вызывать проблемы (например, низкую производительность). 

Инструмент, который выполняет эти проверки автоматически, при каждом изменении, спасет код от постепенного ухудшения. Если не настроить этот процесс, незаметно для всех, в какой-то момент может стать слишком поздно, ведь код будет содержать сотни предупреждений.<table><tbody>

<tr><td>Для корректной работы SpotBugs необходимо использовать Java версии 8 и выше.</td></tr>

</tbody></table>Данный инструмент называют преемником (наследником) общеизвестного статического анализатора <a href="https://javarush.com/groups/posts/1424-findbugs-pomogaet-uznatjh-java-luchshe" target="_blank">FindBugs</a>.

<span class="text-bold">SpotBugs</span> можно в интеграции с:<ul>
<li>Ant</li>
<li>Maven</li>
<li>Gradle</li>
<li>Eclipse</li>

</ul>Также возможно использование через <a href="https://spotbugs.readthedocs.io/en/stable/installing.html" rel="nofollow" target="_blank">скачивание и установку двоичного дистрибутива</a>.

Мы с вами воспользуемся подключением через <a href="https://javarush.com/groups/posts/3119-java-proekt-ot-a-do-ja-vse-chto-vih-khoteli-znatjh-o-maven" target="_blank">Maven</a>.

Добавляем в Maven:

<pre class="language-java line-numbers"><code>
&lt;plugin&gt;
  &lt;groupId&gt;com.github.spotbugs&lt;/groupId&gt;
  &lt;artifactId&gt;spotbugs-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;4.2.2&lt;/version&gt;
  &lt;dependencies&gt;
     &lt;dependency&gt;
        &lt;groupId&gt;com.github.spotbugs&lt;/groupId&gt;
        &lt;artifactId&gt;spotbugs&lt;/artifactId&gt;
        &lt;version&gt;4.2.0&lt;/version&gt;
     &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/plugin&gt;
</code></pre>
Также в разделе плагинов добавляем:

<pre class="language-java line-numbers"><code>
&lt;plugin&gt;
  &lt;artifactId&gt;maven-project-info-reports-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.8&lt;/version&gt;
&lt;/plugin&gt;
</code></pre><h2>Основные команды SpotBugs</h2>Ну а теперь давайте рассмотрим основные команды для SpotBugs, вызываемые либо через консоль Мавена:<img data-max-width="1080" data-id="82b5df52-26a6-4184-a762-1c1efe364a67" src="https://cdn.javarush.com/images/article/82b5df52-26a6-4184-a762-1c1efe364a67/1080.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 3">(чтобы вызвать консоль, нужно нажать на значок <span class="code"><span class="text-bold"><em>m</em></span></span>),

Либо через терминал idea:<img data-max-width="512" data-id="b6e696f1-4714-497a-957e-829b5ec8d5cd" src="https://cdn.javarush.com/images/article/b6e696f1-4714-497a-957e-829b5ec8d5cd/512.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 4"><h3>1. mvn spotbugs:help</h3>Отображает справочную информацию для пользовательского интерфейса командной строки <span class="text-bold">SpotBugs</span>.

Пример результата вызова:<img data-max-width="800" data-id="d62faf80-6339-4e95-a770-591f836e4b5e" src="https://cdn.javarush.com/images/article/d62faf80-6339-4e95-a770-591f836e4b5e/800.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 5">Как мы видим, если запустить команду: 

<span class="text-bold">mvn spotbugs:help -Ddetail=true -Dgoal=&lt;goal-name&gt;</span>

можно узнать подробнее о настройках цели. Или запустить:

<span class="text-bold">mvn spotbugs:help -Ddetail=true</span>

и узнать подробнее обо всех четырех целях.

Например, я запустил <span class="text-bold">mvn spotbugs:help -Ddetail=true -Dgoal=help</span> 

и получил следующее описание:<img data-max-width="800" data-id="f680c4d5-1068-41bb-ba26-8266b2c2ac29" src="https://cdn.javarush.com/images/article/f680c4d5-1068-41bb-ba26-8266b2c2ac29/800.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 6"><h3>2. mvn spotbugs:check</h3>Данная команда запускает анализ и сообщает о неудачной сборке, если обнаруживает какие-либо ошибки из спектра <span class="text-bold">spotbugs</span>.

Пример результата запуска команды:<img data-max-width="1080" data-id="2e5bdead-0074-4b5e-9afd-e0a0fb6660d3" src="https://cdn.javarush.com/images/article/2e5bdead-0074-4b5e-9afd-e0a0fb6660d3/1080.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 7">Тут мы видим, как spotbugs ругается на все найденные недостатки приложения (на найденный плохой код).<h3>3. mvn spotbugs:spotbugs</h3>Данная команда анализирует целевой проект с помощью SpotBugs. Без запуска данной команды, команда по отображению результатов фактически будет бесполезна, т.к. она и производит сам анализ.

После запуска данной команды создаётся файл <span class="text-bold">spotbugsXml.xml</span>, в котором и лежат результаты анализа для дальнейшего отображения.

Также следует отметить, что запуск команды <span class="text-bold">mvn spotbugs:spotbugs</span> сам по себе ничего не даст: сперва нужно запустить стандартную команду для компиляции проекта <span class="text-bold">mvn clean compile</span>, и только после неё — команду для анализа проекта.

Предыдущая рассмотренная команда, <span class="text-bold">mvn spotbugs:check</span>, также анализирует и создаёт файл <span class="text-bold">spotbugsXml.xml</span>, но в отличие от <span class="text-bold">mvn spotbugs:spotbugs</span> она ещё и показывает результат анализа на нижней панели. 

Для анализа таким путём также сперва нужно запустить <span class="text-bold">mvn clean compile</span>, а только потом — <span class="text-bold">mvn spotbugs:check</span>.<h3>4. mvn spotbugs:gui</h3>Пожалуй, данная команда самая интересная: она запускает графический интерфейс SpotBugs для проверки результатов анализа, в котором вы можете подробно рассмотреть, какие недостатки есть в вашем кода и где они находятся.

Но, как я и упомянул выше, для правильной отработки данной команды необходим файл <span class="text-bold">spotbugsXml.xml</span> в папке <span class="text-bold">target</span>, который создаётся после описанных выше манипуляций.

При запуске данной команды получаем следующее графическое отображение:<img data-max-width="1080" data-id="06b46836-ec18-4320-98c9-1421ca263ee9" src="https://cdn.javarush.com/images/article/06b46836-ec18-4320-98c9-1421ca263ee9/1080.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 8">Тут вы можете настраивать фильтрацию по имени класса, группировать по категориям плохого кода и так далее.

Возможные недостатки делятся на типы, которые в свою очередь делятся на конкретные подробные шаблоны ошибок (400+).<h2>Типы ошибок</h2>Давайте же рассмотрим подробнее возможные типы ошибок:<ul>

<li><p><span class="text-bold">Bad practice</span></p>
<p>Нарушения рекомендованной практики написания кода. </p></li>

<li><p><span class="text-bold">Correctness</span></p>
<p>Предполагаемая ошибка кода, приводящая к тому, что код не соответствует замыслу разработчика. Помогает достичь низкого уровня ложных срабатываний.</p></li>

<li><p><span class="text-bold">Experimental</span></p>
<p>Данный архетип описывает экспериментальные и не полностью проверенные шаблоны ошибок (доверять замечаниям с данным типом ошибки следует с большой осторожностью).</p></li>

<li><p><span class="text-bold">Internationalization</span></p>
<p>Тип описывает недостатки кода, связанные с интернационализацией и локализацией.</p></li>

<li><p><span class="text-bold">Malicious code vulnerability</span></p>
<p>Данный тип говорит о том что ваш код уязвим для атак со стороны ненадежного кода.</p></li>

<li><p><span class="text-bold">Multithreaded correctness</span></p>
<p>Тип описывает недостатки кода, связанные с потоками, блокировками. </p></li>

<li><p><span class="text-bold">Bogus random noise </span></p>
<p>Данный тип предназначен для использования как средство контроля в экспериментах по интеллектуальному анализу данных, а не для поиска реальных ошибок в программном обеспечении.</p></li>

<li><p><span class="text-bold">Performance</span></p>
<p>Архетип говорит о том, что ваш код не обязательно неверен, но может быть неэффективным и нуждается в некой оптимизации.</p></li>

<li><p><span class="text-bold">Security</span></p>
<p>Вероятно, вы используете ненадежный входной функционал, у которого могут быть уязвимости, дыры в системы безопасности, допустимые к использованию удаленно.</p></li>

<li><p><span class="text-bold">Dodgy code</span></p>
<p>Под данный тип попадает код, который вводит в заблуждение, является аномальным или написан таким образом, что приводит к ошибкам.</p></li>

</ul>Полное подробное описание ошибок вы можете найти в <a href="https://spotbugs.readthedocs.io/en/stable/bugDescriptions.html" rel="nofollow" target="_blank">этой документации</a>.<img data-max-width="512" data-id="76bdf426-e681-48a6-9e6e-70b46954a469" src="https://cdn.javarush.com/images/article/76bdf426-e681-48a6-9e6e-70b46954a469/512.jpeg" alt="Введение в SpotBugs: инструмент для статического анализа кода - 9"><h2>Файлы фильтров</h2>Для отлова шаблонов “плохого кода” в <span class="text-bold">SpotBugs</span> используются фильтры. По сути фильтр сопоставляет экземпляры ошибок по набору критериев.

Собственно, вы можете составлять собственные вариации шаблонов плохого кода, которые <span class="text-bold">SpotBugs</span> нужно отловить (создать кастомные файлы фильтра).

Также с помощью данных файлов фильтров вы можете задавать ошибки, которые нужно исключать при проверке. Возможно, у вас в проекте что-то будет считаться хорошим решением, что по умолчанию фиксируется в анализаторе как плохая практика.

Файл фильтра — это XML-документ с <span class="text-bold">FindBugsFilter</span> элементом верхнего уровня, у которого есть некоторое количество дочерних элементов <span class="text-bold">Match</span>. Каждый элемент <span class="text-bold">Match</span> представляет собой предикат, который применяется к сгенерированным экземплярам ошибок.

Подробнее о создании файла фильтра можно почитать <a href="https://spotbugs.readthedocs.io/en/stable/filter.html#introduction-to-filter-files" rel="nofollow" target="_blank">в этой документации</a>.